// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  CUSTOMER
  ORGANIZER
}

enum Gender {
  MALE
  FEMALE
}

enum TransactionStatus {
  WAITING_PAYMENT       // User belum upload bukti pembayaran
  WAITING_CONFIRMATION  // user sudah upload, menunggu persetujuan organizer
  DONE                  // disetujui organizer
  REJECTED              // ditolak organizer
  CANCELLED             // expired karena > 2 jam belum upload paymentproof
  EXPIRED               // cancelled karena organizer tidak konfirmasi
}

model User {
  id            String  @id @default(cuid())
  name          String
  email         String  @unique
  password      String
  role          Role    @default(CUSTOMER)
  phoneNumber   String?   @unique 
  birthDate     DateTime? 
  gender        Gender?   
  avatarUrl     String?

  // email verification fields
  isEmailVerified             Boolean     @default(false)

  // Login Tracking Fields
  lastLoginAt             DateTime? // Track kapan terakhir login
  lastLoginIp             String?   // Track dari IP mana
  loginCount              Int       @default(0) // Track berapa kali login

  // Referral System
  referralCode     String  @unique
  referredByUserId String?
  
  // Self-relation
  referredBy       User?   @relation("UserReferrals", fields: [referredByUserId], references: [id])
  referrals        User[]  @relation("UserReferrals")

  // Relations
  events       Event[]       @relation("OrganizerEvents")
  reviews      Review[]
  transactions Transaction[]
  points       Point[]       // History perolehan poin
  coupons      Coupon[]      // Kupon diskon dari referral (System wide)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?       // support soft delete (suspend user)

  @@map("users")
}

model Event {
  id             String   @id @default(cuid())
  name           String
  slug           String   @unique
  description    String   @db.Text
  category		   String
  imageUrl	     String
  
  startDate      DateTime 
  endDate        DateTime 
  
  city           String
  venue          String
  
  ticketTypes    TicketType[] 

  organizerId    String
  organizer      User   @relation("OrganizerEvents", fields: [organizerId], references: [id])

  reviews        Review[]
  transactions   Transaction[]
  promotions     Promotion[] // Voucher dari organizer

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?   // support soft delete (event cancelled/removed)

  @@map("events")
}

// Mengakomodasi "Ticket Types (if applicable)"
model TicketType {
  id        String  @id @default(cuid())
  name      String  // e.g. "VIP", "Presale"
  price     Int
  seats     Int     // Kuota per tipe tiket
  
  eventId   String
  event     Event   @relation(fields: [eventId], references: [id])
  
  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  @@map("ticket_types")
}

model Review {
  id      String  @id @default(cuid())
  rating  Int
  comment String? @db.Text

  userId  String
  user    User   @relation(fields: [userId], references: [id])

  eventId String
  event   Event  @relation(fields: [eventId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  @@map("reviews")
}

// "Reward / Coupon Discount" (System provided, from Referral)
model Coupon {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])

  code       String   // Unique code generated system
  percentage Int      @default(10) // Requirement: discount coupon
  isUsed     Boolean  @default(false)
  expiresAt  DateTime // Requirement: 3 months validity

  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime? // Soft Delete jika kupon ditarik system

  @@map("coupons")
}

model Point {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])

  amount     Int      @default(10000) // Requirement: 10.000 points
  expiresAt  DateTime // Requirement: 3 months validity
  isRedeemed Boolean  @default(false) // True jika sudah dipakai semua? 
                                      // *Note: Point ledger logic itu kompleks. 
                                      // Cara paling mudah: Anggap ini history CREDIT (+). 
                                      // Pengurangan (-) dihitung dari Transaction.pointsUsed.

  createdAt DateTime @default(now())

  @@map("points")
}

// "Voucher Discount" (Organizer provided)
model Promotion {
  id        String   @id @default(cuid())
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id])

  code      String   @unique
  type      String   // FLAT or PERCENTAGE
  value     Int
  maxUsage  Int?
  startDate DateTime
  endDate   DateTime

  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime? // Soft Delete jika organizer stop promo

  @@map("promotions")
}

model Transaction {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  eventId   String
  event     Event    @relation(fields: [eventId], references: [id])
  
  // Link ke TicketType
  ticketTypeId String?
  ticketType   TicketType? @relation(fields: [ticketTypeId], references: [id])

  qty         Int      @default(1)
  totalPrice  Int      // Harga tiket * qty

  // Discount Logic
  pointsUsed  Int      @default(0)
  
  couponId    String?
  coupon      Coupon?  @relation(fields: [couponId], references: [id])
  
  promotionId String?
  promotion   Promotion? @relation(fields: [promotionId], references: [id])

  finalPrice  Int

  // Transaction Flow
  status      TransactionStatus @default(WAITING_PAYMENT)
  
  // Deadline Tracking
  paymentProof String? // URL gambar bukti bayar
  paymentProofUploadedAt DateTime? // mencatat waktu kapan bukti pembayaran di uplaod
  expiresAt DateTime? // 2 jam countdown (batas waktu pembayaran bagi user)
  organizerResponseDeadline DateTime? // 3 hari deadline (batas waktu response dari Organizer)

  // reminder tracking
  reminderSent Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("transactions")
}